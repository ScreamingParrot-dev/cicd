name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  # Этап линтинга
  linting:
    name: Code Linting
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install Pylint
      run: pip install pylint
    
    - name: Run Pylint analysis
      run: |
        echo "Running Pylint code analysis..."
        mkdir -p reports
        pylint app/ --exit-zero > reports/pylint-report.txt
        echo "Pylint analysis completed"
    
    - name: Upload linting artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: linting-results
        path: reports/

  # Этап тестирования
  test:
    name: Unit Testing
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: pip install pytest
    
    - name: Debug Check project structure
      run: |
        echo "Current directory:"
        pwd
        echo ""
        echo "Project structure:"
        find . -name "*.py" | sort
        echo ""
        echo "Test directory:"
        ls -la tests/
        echo ""
        echo "App directory:"
        ls -la app/
    
    - name: Run unit tests
      run: |
        echo "Running unit tests..."
        
        # Способ 1: Используем unittest через pytest
        python -m pytest tests/ -v
        
        # Способ 2: Или напрямую unittest
        # python -m unittest discover -s tests -v
        
        echo "Unit tests completed"
    
    - name: Upload test artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: |
          test-reports/
          .coverage

  # Этап безопасности
  security:
    name: Security Check
    runs-on: ubuntu-latest
    needs: [linting, test]
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install Safety
      run: pip install safety
    
    - name: Run security check
      run: |
        echo "Running security scan..."
        mkdir -p security-reports
        pip freeze > all-dependencies.txt
        safety check -r all-dependencies.txt --output security-reports/safety-report.txt || true
        echo "Security scan completed"
    
    - name: Upload security artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-results
        path: security-reports/

  # Этап нотификации
  notify:
    name: Notifications
    runs-on: ubuntu-latest
    needs: [linting, test, security]
    if: always()
    
    steps:
    - name: Check workflow status
      run: |
        echo "=== CI/CD PIPELINE STATUS ==="
        echo "Linting: ${{ needs.linting.result }}"
        echo "Testing: ${{ needs.test.result }}"
        echo "Security: ${{ needs.security.result }}"
        echo "============================="