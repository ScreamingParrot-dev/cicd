name: CI/CD Pipeline

env:
  PYTHON_VERSION: '3.9'

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  # Этап линтинга (linting) - выполняется ПАРАЛЛЕЛЬНО с тестами
  linting:
    name: Code Linting
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      
    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install Pylint
      run: pip install pylint
    
    - name: Create pylint configuration
      run: |
        echo "[MASTER]
        ignore=tests
        disable=missing-docstring
        
        [FORMAT]
        max-line-length=120
        
        [MESSAGES CONTROL]
        max-line-length=120" > .pylintrc
    
    - name: Run Pylint analysis
      run: |
        echo "Running Pylint code analysis..."
        mkdir -p reports
        pylint app/ --rcfile=.pylintrc --exit-zero > reports/pylint-report.txt
        echo "Pylint analysis completed"
    
    - name: Upload linting artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: linting-results
        path: reports/
        retention-days: 7

  # Этап тестирования (test) - выполняется ПАРАЛЛЕЛЬНО с линтингом
  test:
    name: Unit Testing
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      
    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install dependencies
      run: |
        pip install -r requirements.txt
    
    - name: Run unit tests
      run: |
        echo "Running unit tests..."
        mkdir -p test-reports
        python -m pytest tests/ -v --junitxml=test-reports/junit.xml
        echo "Unit tests completed"
    
    - name: Upload test artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: test-reports/
        retention-days: 7

  # Этап проверки безопасности (security)
  security:
    name: Security Check
    runs-on: ubuntu-latest
    needs: [linting, test]  # Зависит от успешного выполнения linting и test
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      
    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install Safety
      run: pip install safety
    
    - name: Run security check
      run: |
        echo "Running security scan..."
        mkdir -p security-reports
        
        # Создаем файл со всеми зависимостями
        pip freeze > all-dependencies.txt
        
        # Проверяем зависимости на уязвимости
        safety check -r all-dependencies.txt --output security-reports/safety-report.txt || true
        
        echo "Security scan completed"
    
    - name: Upload security artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-results
        path: security-reports/
        retention-days: 7

  # Этап уведомлений (опционально)
  notify:
    name: Notifications
    runs-on: ubuntu-latest
    needs: [linting, test, security]
    if: always()
    
    steps:
    - name: Check workflow status
      run: |
        echo "=== WORKFLOW STATUS ==="
        echo "Linting job status: ${{ needs.linting.result }}"
        echo "Testing job status: ${{ needs.test.result }}"
        echo "Security job status: ${{ needs.security.result }}"
        
        # Простая проверка статуса
        if [ "${{ needs.linting.result }}" = "success" ] && [ "${{ needs.test.result }}" = "success" ] && [ "${{ needs.security.result }}" = "success" ]; then
          echo "All jobs completed successfully!"
          exit 0
        else
          echo "Some jobs failed!"
          exit 1
        fi