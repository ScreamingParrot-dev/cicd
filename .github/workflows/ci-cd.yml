name: CI/CD Pipeline

# Переменные окружения для конфигурации инструментов
env:
  PYTHON_VERSION: '3.9'
  PYLINT_RCFILE: '.pylintrc'
  SAFETY_FORMAT: 'json'

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  # Этап линтинга (linting)
  linting:
    name: Code Linting
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      
    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install Pylint
      run: pip install pylint==${{ env.PYLINT_VERSION || '2.15.0' }}
    
    - name: Run Pylint analysis
      run: |
        # Создаем конфигурацию pylint
        echo "[MASTER]
        ignore=tests
        [FORMAT]
        max-line-length=100" > ${{ env.PYLINT_RCFILE }}
        
        # Запускаем линтинг и сохраняем отчет
        mkdir -p reports
        pylint app/ --rcfile=${{ env.PYLINT_RCFILE }} --exit-zero > reports/pylint-report.txt
    
    - name: Upload linting artifacts
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: linting-results
        path: reports/
        retention-days: 7

  # Этап тестирования (test) - выполняется ПАРАЛЛЕЛЬНО с линтингом
  test:
    name: Unit Testing
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      
    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install dependencies
      run: |
        pip install -r requirements.txt
    
    - name: Run unit tests
      run: |
        # Создаем директорию для отчетов
        mkdir -p test-reports
        
        # Запускаем тесты с созданием отчета
        python -m pytest tests/ -v --junitxml=test-reports/junit.xml
        
        # Считаем количество тестов
        TEST_COUNT=$(python -m pytest tests/ --collect-only | grep "test_" | wc -l)
        echo "Total tests: $TEST_COUNT"
    
    - name: Upload test artifacts
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: test-results
        path: test-reports/
        retention-days: 7

  # Этап проверки безопасности (security)
  security:
    name: Security Check
    runs-on: ubuntu-latest
    needs: [linting, test]  # Зависит от успешного выполнения linting и test
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      
    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install Safety
      run: pip install safety
    
    - name: Run security check
      run: |
        # Создаем файл со всеми зависимостями
        pip freeze > all-dependencies.txt
        
        # Проверяем зависимости на уязвимости
        mkdir -p security-reports
        
        # Формат вывода зависит от переменной окружения
        safety check -r all-dependencies.txt --output security-reports/safety-report.txt
        
        # Также сохраняем в JSON если нужно
        safety check -r all-dependencies.txt --json > security-reports/safety-report.json || true
        
        echo "Security scan completed"
    
    - name: Upload security artifacts
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: security-results
        path: security-reports/
        retention-days: 7

  # Этап уведомлений (по желанию, но в задании есть)
  notify:
    name: Notifications
    runs-on: ubuntu-latest
    needs: [linting, test, security]
    if: always()  # Всегда запускаем, даже если предыдущие этапы упали
    
    steps:
    - name: Check workflow status
      run: |
        echo "Workflow completed with status:"
        echo "Linting: ${{ needs.linting.result }}"
        echo "Testing: ${{ needs.test.result }}"
        echo "Security: ${{ needs.security.result }}"
        
        # Здесь можно добавить интеграцию с Slack/Telegram/Email
        # Например, через curl к webhook
        # Но это опционально и требует настройки секретов
        
        if [[ "${{ needs.linting.result }}" == "failure" || 
              "${{ needs.test.result }}" == "failure" || 
              "${{ needs.security.result }}" == "failure" ]]; then
          echo "Pipeline failed!"
          # Отправляем уведомление об ошибке
        else
          echo "Pipeline succeeded!"
        fi